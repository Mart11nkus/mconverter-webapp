<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>MConverter</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --card:rgba(255,255,255,.07);
  --stroke:rgba(255,255,255,.16);
  --text:#fff;
  --muted:rgba(255,255,255,.68);
  --radius:20px;
  --radius2:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}

body{
  min-height:100vh;
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  position:relative;
  background:#000;
  overflow:auto;
}

.bg{
  position:fixed;
  inset:0;
  background:url("bg.jpg") center center / cover no-repeat;
  z-index:0;
  filter: brightness(1.10) contrast(1.18) saturate(0.85);
}
.bg::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 50% 22%, rgba(0,0,0,.00), rgba(0,0,0,.45) 72%),
    linear-gradient(to bottom, rgba(0,0,0,.12), rgba(0,0,0,.28));
}

.noise{
  position:fixed;
  inset:0;
  z-index:1;
  pointer-events:none;
  opacity:.14;
  background-image:url("https://grainy-gradients.vercel.app/noise.svg");
  mix-blend-mode:overlay;
}

.glitchWrap{
  position:fixed;
  inset:0;
  z-index:2;
  pointer-events:none;
}
.scanlines{
  position:absolute; inset:0;
  opacity:0;
  background:
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 10px,
      rgba(255,255,255,.22) 11px,
      rgba(255,255,255,0) 14px
    );
}
.slice{
  position:absolute;
  left:-10%;
  width:120%;
  height:80px;
  top:35%;
  background: rgba(255,255,255,.12);
  opacity:0;
  filter: blur(.3px);
}
.shake{
  position:absolute;
  inset:0;
  opacity:0;
  transform: translate(0,0);
}
@keyframes linesPop{
  0%{opacity:0; transform:translateY(0)}
  10%{opacity:1; transform:translateY(-10px)}
  35%{opacity:.85; transform:translateY(6px)}
  70%{opacity:1; transform:translateY(-4px)}
  100%{opacity:0; transform:translateY(0)}
}
@keyframes sliceMove{
  0%{opacity:0; transform:translateY(-40px)}
  15%{opacity:1; transform:translateY(0px)}
  45%{opacity:.85; transform:translateY(18px)}
  100%{opacity:0; transform:translateY(60px)}
}
@keyframes shakeIt{
  0%{opacity:0; transform:translate(0,0)}
  10%{opacity:1; transform:translate(-2px, 1px)}
  25%{transform:translate(2px, -1px)}
  40%{transform:translate(-3px, 2px)}
  55%{transform:translate(3px, 0px)}
  70%{transform:translate(-2px, -2px)}
  100%{opacity:0; transform:translate(0,0)}
}

.container{
  position:relative;
  z-index:3;
  max-width:560px;
  margin:0 auto;
  padding:18px 14px calc(26px + env(safe-area-inset-bottom));
  display:flex;
  flex-direction:column;
  gap:16px;
}

.logoWrap{
  display:flex;
  justify-content:center;
  margin-top:6px;
}
.logoWrap img{
  width:240px;
  filter: drop-shadow(0 20px 45px rgba(0,0,0,.85));
}
@media (max-height: 720px){
  .logoWrap img{ width:200px; }
  .container{ padding-top:12px; }
}

.card{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  padding:16px;
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
}

label{
  font-size:13px;
  color:var(--muted);
  display:block;
  margin-bottom:8px;
}

input{
  width:100%;
  padding:14px;
  border-radius:var(--radius2);
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.09);
  color:white;
  font-size:14px;
  outline:none;
}

.tabs,.formats{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.tabs button,.formats button{
  flex:1;
  padding:12px;
  border-radius:var(--radius2);
  border:1px solid var(--stroke);
  background:rgba(255,255,255,.09);
  color:white;
  font-weight:700;
  cursor:pointer;
  transition:.2s;
}

.tabs button.active,
.formats button.active{
  background:white;
  color:black;
  border-color:white;
}

.note{
  font-size:11px;
  margin-top:6px;
  color:rgba(255,255,255,.55);
  line-height:1.25;
}

.convertBtn{
  width:100%;
  margin-top:14px;
  padding:16px;
  border-radius:18px;
  border:none;
  background:white;
  color:black;
  font-weight:800;
  letter-spacing:1px;
  cursor:pointer;
  transition:.15s;
}
.convertBtn:active{transform:scale(.98)}
.convertBtn:disabled{opacity:.55; cursor:not-allowed}

.status{
  margin-top:12px;
  font-size:13px;
  color:var(--muted);
  text-align:center;
}

.progressWrap{
  width:100%;
  height:8px;
  background:rgba(255,255,255,.10);
  border-radius:10px;
  margin-top:12px;
  overflow:hidden;
  display:none;
}
.progressBar{
  height:100%;
  width:0%;
  background:#fff;
  transition:width .35s ease;
}

.hr{
  margin:18px 0;
  opacity:.2;
  border:none;
  border-top:1px solid rgba(255,255,255,.18);
}
</style>
</head>

<body>

<div class="bg"></div>
<div class="noise"></div>

<div class="glitchWrap" aria-hidden="true">
  <div class="shake" id="shake">
    <div class="scanlines" id="scanlines"></div>
    <div class="slice" id="slice"></div>
  </div>
</div>

<div class="container">

  <div class="logoWrap">
    <img src="logo.png" alt="MConverter">
  </div>

  <div class="card">
    <label>Ссылка</label>
    <input id="link" placeholder="Вставь ссылку..." />
  </div>

  <div class="card">
    <label>Платформа</label>
    <div class="tabs">
      <button class="active" data-platform="youtube">YouTube</button>
      <button data-platform="tiktok">TikTok</button>
      <button data-platform="instagram">Insta</button>
    </div>
    <div class="note">Instagram признана экстремистской организацией и запрещена на территории РФ</div>

    <label style="margin-top:12px;">Формат</label>
    <div class="formats">
      <button class="active" data-format="mp3">MP3</button>
      <button data-format="mp4">MP4</button>
    </div>

    <button class="convertBtn" id="btnLink" type="button">CONVERT LINK</button>

    <hr class="hr">

    <label>MP4 файл (MP4 → MP3)</label>
    <input id="mp4file" type="file" accept="video/mp4,video/*" />
    <button class="convertBtn" id="btnFile" disabled type="button">CONVERT MP4 → MP3</button>

    <div class="progressWrap" id="progressWrap">
      <div class="progressBar" id="progressBar"></div>
    </div>

    <div class="status" id="status">Готов к работе</div>
  </div>

</div>

<script>
const API_BASE = https://actual-occurring-homes-flashing.trycloudflare.com
const tg = window.Telegram?.WebApp;
if(tg){ tg.expand(); tg.ready?.(); }

const statusEl = document.getElementById("status");
const progressWrap = document.getElementById("progressWrap");
const progressBar = document.getElementById("progressBar");

function setStatus(t){ statusEl.textContent = t; }
function setProgress(p){
  progressWrap.style.display = "block";
  progressBar.style.width = Math.max(0, Math.min(100, p)) + "%";
}
function resetProgress(){
  progressWrap.style.display = "none";
  progressBar.style.width = "0%";
}

let platform="youtube";
let format="mp3";

document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    platform=btn.dataset.platform;
  };
});
document.querySelectorAll(".formats button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".formats button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    format=btn.dataset.format;
  };
});

async function pollJob(jobId){
  const tick = async ()=>{
    try{
      const r = await fetch(`${API_BASE}/job-status/${jobId}`);
      const j = await r.json();
      if(j.status==="queued"){ setStatus("В очереди…"); setProgress(30); setTimeout(tick,1200); return; }
      if(j.status==="downloading"){ setStatus("Скачиваю…"); setProgress(40); setTimeout(tick,1200); return; }
      if(j.status==="sending"){ setStatus("Отправляю в чат…"); setProgress(90); setTimeout(tick,1200); return; }
      if(j.status==="done"){ setStatus("Готово ✅ Проверь чат"); setProgress(100); setTimeout(()=>{ resetProgress(); },1200); return; }
      if(j.status==="error"){ setStatus("Ошибка ❌ "+(j.error?String(j.error).slice(0,140):"")); resetProgress(); return; }
      setTimeout(tick,1500);
    }catch(e){ setTimeout(tick,2000); }
  };
  setTimeout(tick,900);
}

document.getElementById("btnLink").onclick = async ()=>{
  const link = document.getElementById("link").value.trim();
  if(!link){ setStatus("Вставь ссылку"); return; }
  if(format !== "mp3"){ setStatus("Сейчас по ссылке доступно только MP3. Выбери MP3."); return; }
  const initData = window.Telegram?.WebApp?.initData || "";
  if(!initData){ setStatus("Открой из Telegram"); return; }

  setStatus("Отправляю ссылку…");
  resetProgress();
  setProgress(15);

  const form = new FormData();
  form.append("url", link);
  form.append("init_data", initData);

  try{
    const res = await fetch(`${API_BASE}/download-by-url`, { method:"POST", body: form });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){ setStatus("Ошибка сервера: "+(data.detail||"unknown")); resetProgress(); return; }
    setStatus("Принято ✅ Жди в чате");
    setProgress(22);
    pollJob(data.job_id);
  }catch(e){
    setStatus("Ошибка сети");
    resetProgress();
  }
};

const fileInput = document.getElementById("mp4file");
const btnFile = document.getElementById("btnFile");
let selectedFile = null;

fileInput.addEventListener("change", ()=>{
  selectedFile = fileInput.files?.[0] || null;
  btnFile.disabled = !selectedFile;
  resetProgress();
  setStatus(selectedFile ? "Файл выбран" : "Готов к работе");
});

btnFile.addEventListener("click", async ()=>{
  if(!selectedFile) return;
  const initData = window.Telegram?.WebApp?.initData || "";
  if(!initData){ setStatus("Открой из Telegram"); return; }

  btnFile.disabled = true;
  setStatus("Отправляю файл…");
  setProgress(12);

  const form = new FormData();
  form.append("file", selectedFile, selectedFile.name);
  form.append("init_data", initData);

  try{
    const res = await fetch(`${API_BASE}/upload-mp4`, { method:"POST", body: form });
    const data = await res.json().catch(()=>({}));
    if(!res.ok){ setStatus("Ошибка сервера: "+(data.detail||"unknown")); resetProgress(); btnFile.disabled=false; return; }
    setStatus("Принято ✅ Жди в чате");
    setProgress(25);
    pollJob(data.job_id);
  }catch(e){
    setStatus("Ошибка сети");
    resetProgress();
    btnFile.disabled=false;
  }
});

// glitch
const scanlines = document.getElementById("scanlines");
const slice = document.getElementById("slice");
const shake = document.getElementById("shake");

function play(el, anim, dur){
  el.style.animation="none";
  void el.offsetWidth;
  el.style.animation=`${anim} ${dur}ms ease-out`;
  setTimeout(()=> el.style.animation="none", dur+40);
}
function glitch(){
  play(shake,"shakeIt",260+Math.random()*220);
  play(scanlines,"linesPop",260+Math.random()*240);
  slice.style.top=(18+Math.random()*62)+"%";
  slice.style.height=(50+Math.random()*110)+"px";
  play(slice,"sliceMove",220+Math.random()*220);
  if(Math.random()>0.65){
    setTimeout(()=>{
      play(shake,"shakeIt",220+Math.random()*200);
      play(scanlines,"linesPop",220+Math.random()*220);
    },140+Math.random()*220);
  }
}
setInterval(()=>{ if(Math.random()>0.45) glitch(); },1400);
</script>

</body>
</html>


